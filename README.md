# spring-gift-enhancement

## 1단계
### 상품 카테고리 도입
- 각 상품은 하나의 카테고리를 가질 수 있다. (다대일 관계)
- 카테고리 자체를 수정할 수 있다.
- 상품의 카테고리 설정도 변경할 수 있다.
- 관리자 화면에서 상품을 추가할 때 카테고리를 지정할 수 있다.

### Model
#### Product
- 멤버 변수로 Category 추가(not null)
- @ManyToOne
#### Category
- id(PK)
- name(Unique)
  - 20자 이하
  
### Repository
#### CategoryRepository
- save
- findAll
- findById
- update
- delete

### Service
#### CategoryService
- 카테고리 추가
- 카테고리 조회
- 카테고리 변경
- 카테고리 삭제
#### ProductService
- 상품에 카테고리 추가
- 상품에 카테고리 변경

### Controller
#### CategoryApiController
- 카테고리 조회/추가/변경 삭제 요청

#### ProductApiController
- 상품과 카테고리 복합 요청
  - 상품 추가 시 카테고리 설정
  - 상품의 카테고리 변경

## 2단계
### 상품 옵션 도입
- 각 상품은 하나 이상의 옵션을 가진다. (1:N 관계)
- 옵션 이름은 공백을 포함하여 50자까지 입력할 수 있다.
  - 특수 문자는 "( ), [ ], +, -, &, /, _"만 허용한다.
- 상품의 옵션 당 수량(재고)은 1~100,000,000개 이다.
- 동일한 상품 내 옵션의 이름은 중복될 수 없다.

### Model
#### Options
- id(pk)
- name(unique)
  - null 불가
  - 50자 이하
  - 일부 특수문자 허용
- quantity
  - 1개~1억개
- product
  - @ManyToOne

### Repository
#### OptionsRepository
- save
- findAll
- findById
- update
- delete

### Service
#### OptionsService
- 옵션 추가
- 옵션 조회
- 옵션 수정
  - 옵션명 변경
  - 재고 변경
- 옵션 삭제
  - 삭제하고 남은 옵션이 1개 이상일 경우에만 삭제가 가능함

### Controller
#### ProductApiController
- 상품과 옵션 복합 요청
  - 상품 생성
    - 최소 하나의 옵션과 함께 생성
  - 상품 조회
    - 모든 옵션 목록과 함께 제공
    - 특정 옵션과 함께 제공
  - 상품 삭제
    - 모든 옵션들도 함께 삭제
#### OptionsApiController
  - 옵션 생성
  - 옵션 변경
  - 옵션 삭제

## 3단계
### 상품 옵션 수량 차감 기능 구현
- 옵션에 대해 요구하는 수량만큼 기존 수량에서 차감한다.

### Service
- 옵션 수량 수정
  - 예외 상황 발생 시, OptionsQuantityException 쓰로잉
### Options
  - quantity validation
  - 차감하고 남은 수량 검증
  - 실제 Entity 내 quantity 값 수정

## 4단계
### 상품 옵션 수량 차감에 대한 동시성 제어
- 상품 옵션 수량 차감에 대해 다수의 요청이 동시에 발생했을 때, 이를 제어할 수 있도록 한다.
### 낙관적 락 vs 비관적 락
- 동시성을 제어하는 두 가지 방식 중 어떤 방식을 택할 것인가?
### 고려사항
- 옵션 수량 차감에 대한 동시 접근이 자주 발생하는가?
  => 자주 발생하면 안전한 처리를 위해 비관적 락이 유리할 것
- 동시 접근이 발생했을 때 애플리케이션에서의 처리 로직이 복잡한가?
  => 복잡하지 않다면 낙관적 락이 유리할 것
### 판단
- 인기가 매우 많은 상품 옵션이나 세일 이벤트에 한해 단시간에 다수의 주문 요청이 들어올 수 있지만, 특수 상황을 제외하고 대부분의 상황이나 옵션에는 동시 접근이 발생하는 경우가 드물다.
- 따라서 낙관적 락을 적용하는 것이 평균적인 요청 수 대비 좋은 성능을 발휘할 수 있을 것으로 보인다.
### 상품 옵션 차감의 동시성 제어에 낙관적 락을 적용한다.
- 같은 버전의 업데이트가 이미 요청되었다면 요청에 실패하여, 다시 요청을 시도한다.
- 일정 횟수동안 재시도를 함에도 요청에 실패한다면, 최종적으로 예외를 던지고 사용자에게 다시 시도하라고 알려준다.
- 별개로 이미 재고가 0이 되어 차감이 불가능한 경우, 이를 사용자에게 알려준다.